{"version":3,"file":"worker.min.js","sources":["CPU/CPU-test-event.js","common/utils.js","CPU/worker.js"],"sourcesContent":["export const START_TEST = 0;\nexport const STOP_TEST = 1;\nexport const RESULT_SUCCESS = 2;\nexport const RESULT_FAILED = 3;\nexport const TEST_RUNNING = 4;\nexport const TEST_STOPPED = 5;\nexport const WORKER_READY = 6;","\nexport const isFunction = func => (typeof func) === \"function\";\n\nexport const isAbsent = value => (value === undefined) || (value === null);\n\n// For array, set or map-like objects\nexport const isEmpty = value => (value.size === 0) || (value.length === 0);\n\n/**\n * Shallow immutability for pure data carriers. Use sparingly.\n */\nexport const Î¾ = anyObj => Object.freeze(Object.assign(Object.create(null), anyObj));\n\n// Unclamped setTimeout using MessageChannel (For throttling behaviour: https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout#Notes)\n// Creates \"macro\" tasks, which plays nicer with the main UI thread: (For macro/micro distinction: https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask)\nconst channel = new MessageChannel();\nconst receiver = channel.port1;\nconst sender = channel.port2;\n\n// In an earlier project, I've tested that map here is faster than array or plain objects in both Firefox and Chrome.\n// Not sure if it's still true, but the difference wasn't big.\nconst queuedTasks = new Map();\nlet nextTaskID = 0;\n\nreceiver.onmessage = event => {\n\tconst taskID = event.data;\n\tif (queuedTasks.has(taskID)) {\n\t\t// Run if not cancelled\n\t\tconst task = queuedTasks.get(taskID);\n\t\tqueuedTasks.delete(taskID);\n\t\ttask();\n\t}\n};\n\n/**\n * @returns The id of the given task, which can be used to cancel that task\n */\nexport const queueTask = func => {\n\tif (!isFunction(func)) {\n\t\tthrow new Error(\"Not a function\");\n\t}\n\n\tconst currentID = nextTaskID;\n\t++nextTaskID;\n\tqueuedTasks.set(currentID, func);\n\tsender.postMessage(currentID);\n\n\treturn currentID;\n};\n\n/**\n * @returns True if the task was in the queue and is now removed, false if the id doesn't correspond to any tasks in the queue\n */\nexport const cancelTask = taskID => queuedTasks.delete(taskID);","// Firefox currently doesn't support modules in web workers yet, so\n// emscripten is compiling to non module code. Relying on rollup+terser\n// to remove all other module imports.\nimportScripts(\"WasmTest.js\");\n\nimport { START_TEST, TEST_STOPPED, TEST_RUNNING, STOP_TEST, WORKER_READY } from \"./CPU-test-event.js\";\nimport { queueTask, cancelTask, isFunction } from \"../common/utils.js\";\n\nself.Module().then(WasmTest => {\n\n\tlet testStatus = TEST_STOPPED;\n\tlet result = 0;\n\tlet testTaskId = undefined;\n\tlet startTime = undefined;\n\n\tconst testFunction = () => {\n\t\tif (testStatus === TEST_RUNNING) {\n\t\t\tresult += WasmTest._runTest();\n\t\t\ttestTaskId = queueTask(testFunction);\n\t\t}\n\t};\n\n\tself.addEventListener(\"message\", e => {\n\t\tconsole.log(e.data);\n\n\t\tif ((e.data === START_TEST) && testStatus !== TEST_RUNNING) {\n\t\t\ttestStatus = TEST_RUNNING;\n\t\t\tresult = 0;\n\t\t\ttestTaskId = queueTask(testFunction);\n\t\t\tstartTime = performance.now();\n\t\t}\n\t\tif ((e.data === STOP_TEST) && testStatus === TEST_RUNNING) {\n\t\t\ttestStatus = TEST_STOPPED;\n\t\t\tcancelTask(testTaskId);\n\t\t\ttestTaskId = undefined;\n\t\t\tpostMessage(result);\n\t\t\tconsole.log(`Test duration: ${performance.now() - startTime}`);\n\t\t}\n\t});\n\n\tpostMessage(WORKER_READY);\n});\n"],"names":["channel","MessageChannel","receiver","port1","sender","port2","queuedTasks","Map","nextTaskID","onmessage","event","taskID","data","has","task","get","delete","queueTask","func","isFunction","Error","currentID","set","postMessage","importScripts","self","Module","then","WasmTest","testStatus","result","testTaskId","undefined","startTime","testFunction","_runTest","addEventListener","e","console","log","performance","now"],"mappings":"AAAO,MCeDA,EAAU,IAAIC,eACdC,EAAWF,EAAQG,MACnBC,EAASJ,EAAQK,MAIjBC,EAAc,IAAIC,IACxB,IAAIC,EAAa,EAEjBN,EAASO,UAAYC,IACpB,MAAMC,EAASD,EAAME,KACrB,GAAIN,EAAYO,IAAIF,GAAS,CAE5B,MAAMG,EAAOR,EAAYS,IAAIJ,GAC7BL,EAAYU,OAAOL,GACnBG,MAOK,MAAMG,EAAYC,IACxB,IArCyBA,CAAAA,GAA0B,mBAAVA,EAqCpCC,CAAWD,GACf,MAAM,IAAIE,MAAM,kBAGjB,MAAMC,EAAYb,EAKlB,QAJEA,EACFF,EAAYgB,IAAID,EAAWH,GAC3Bd,EAAOmB,YAAYF,GAEZA,GC5CRG,cAAc,eAKdC,KAAKC,SAASC,KAAKC,IAElB,IAAIC,EFLuB,EEMvBC,EAAS,EACTC,OAAaC,EACbC,OAAYD,EAEhB,MAAME,EAAe,KFXM,IEYtBL,IACHC,GAAUF,EAASO,WACnBJ,EAAad,EAAUiB,KAIzBT,KAAKW,iBAAiB,UAAWC,ID+BR1B,IAAAA,EC9BxB2B,QAAQC,IAAIF,EAAEzB,MFvBU,IEyBnByB,EAAEzB,MFrBmB,IEqBKiB,IAC9BA,EFtByB,EEuBzBC,EAAS,EACTC,EAAad,EAAUiB,GACvBD,EAAYO,YAAYC,OF5BF,IE8BlBJ,EAAEzB,MF3BmB,IE2BIiB,IAC7BA,EF3ByB,ECgDFlB,ECpBZoB,EDoBsBzB,EAAYU,OAAOL,GCnBpDoB,OAAaC,EACbT,YAAYO,GACZQ,QAAQC,IAAI,mBAAkBC,YAAYC,MAAQR,OAIpDV,YFlC2B"}